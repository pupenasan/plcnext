[Сервісні компоненти](..\README.md)

# Proficloud V3 Device Management Service

https://www.plcnext.help/te/Service_Components/PROFICLOUD/Proficloud_V3_Introduction.htm

## Про Proficloud V3

Proficloud V3 — це нещодавно створене середовище хмарних обчислень Phoenix Contact, доступне за адресою [www.proficloud**.io**](https://proficloud.io). Уже кілька років Phoenix Contact уже розміщує відому службу Proficloud на [www.proficloud**.net**](https://www.proficloud.net), надаючи [службу даних часових рядів (TSD) ](https://www.plcnext.help/te/Service_Components/PROFICLOUD/Transferring_values_to_PROFICLOUD.htm) і підтримку онлайн-інсталяції на контролери з PLCnext Store. Новий Proficloud V3 був побудований як абсолютно нове середовище на основі нових архітектур і технологій. Деякий час обидві версії існуватимуть разом. Усі функції відомого Proficloud залишаться доступними, і на даний момент користувачі також можуть використовувати обидва підключення одночасно на контролері.

Проте незабаром планується об’єднати користувачів, пристрої та функції з Proficloud V3, але протягом перехідного періоду для використання Proficloud V3 може знадобитися **новий обліковий запис користувача**.

Proficloud V3 пропонує простий спосіб керування та обслуговування віддалених пристроїв PLCnext, таких як контролери на вітрових електростанціях. Основні функції:

- Показ **огляду пристроїв** із точною геолокацією всіх підключених пристроїв
- Відображення стану **справності** всіх підключених пристроїв
- Показ ключової **інформації** для всіх підключених пристроїв
- Звітування про **журнали** з підключених пристроїв
- Перевірка наявності **оновлень прошивки** та оновлення на підключених пристроях через хмару
- Використання даних часових рядів (TSD) з підключеного PLCnext Control

У майбутньому будуть доступні додаткові сервіси.

Для реєстрування в Proficloud потрібна лише поштова скринька: 

1. Відкрийте [www.proficloud.io](https://proficloud.io) у браузері та зареєструйтеся як користувач
2. Підтвердіть обліковий запис користувача, відповівши на повідомлення електронної пошти, надіслане на адресу, указану разом з обліковим записом

## Підключення PLCnext до Proficloud V3

У цій темі ви прочитаєте, як підготувати свій PLCnext Control до роботи з Proficloud V3.

### 1. Отримання сетифікату користувача Proficloud V3

Сертифікат користувача потрібний, лише якщо ви хочете на своїх пристроях PLCnext оновлювати мікропрограму (прошивку)  через Proficloud V3. Цей сертифікат є конкретним для облікового запису користувача, тому всі пристрої в обліковому записі працюватимуть з одним сертифікатом, але його потрібно розмістити на кожному пристрої, який має працювати через Proficloud V3. Цю підготовку на пристрої буде виконано на наступному етапі цих інструкцій.

1) Увійдіть у свій обліковий запис користувача на [www.proficloud.io](https://proficloud.io)

2) Натисніть піктограму користувача у верхньому правому куті та виберіть у спадному меню `Settings`.  ![img](media/ProficloudV3_18.png)        

Натисніть кнопку `DOWNLOAD USER CA CERTIFICATE` :
          ![img](media/ProficloudV3_17.png)
          

Файл сертифікату `.crt` завантажується на ваш комп’ютер

### 2. Увімкніть підключення Proficloud V3 на пристрої PLCnext  

Цей крок виконується за допомогою Web-Based Management (WBM) на кожному пристрої PLCnext. Сторінка Proficloud V3 WBM надає інформацію про стан підключення між PLCnext Control AXC F 2152 і Proficloud V3. Ви також можете вказати, чи бажаєте ви керувати контролером із підключенням Proficloud V3 чи без нього.

![img](media/WBM_Proficloud_V3_page1.png)

Якщо ви хочете керувати контролером за допомогою підключення Proficloud V3, вам потрібно увімкнути службу Proficloud V3 контролера. Коли послугу Proficloud V3 контролера ввімкнено, контролер намагається встановити з’єднання з Proficloud V3.

- Увімкніть прапорець `Enable Proficloud V3 Service`.
- Натисніть на кнопку `Apply` .

Підключення Proficloud V3 для контролера увімкнено. Аналогічно робиться відімкнення пристрою від Proficloud. 

Якщо пристрій PLCnext скинуто до заводських налаштувань за замовчуванням, ці дії потрібно виконати ще раз, щоб використовувати пристрій із Proficloud V3. 

### 3. Підготовка пристрою PLCnext до Proficloud V3

- Переконайтеся, що для годинника реального часу (RTC) пристрою встановлено `UTC0`, **а не** часовий пояс, де знаходиться пристрій. `UTC0` — це UTC±00:00 універсального координованого часу (UTC), яке також є значенням за замовчуванням для кожного пристрою PLCnext, тому зазвичай нічого не потрібно змінювати, щоб відповідати потребам Proficloud V3. 
- Переконайтеся, що шлюз мережевого підключення налаштовано правильно, щоб пристрій PLCnext міг підключитися до служб в Інтернеті.

Якщо пристрій PLCnext скинуто до заводських налаштувань за замовчуванням, ці дії потрібно виконати ще раз, щоб використовувати пристрій із Proficloud V3.

### 4. Зареєструйте Trust Store для Proficloud V3 

Proficloud V3 має бути надійним джерелом, що відображається сертифікатом у Trust Store. 

1) Додайте новий Trust Store під назвою `proficloudv3` (з урахуванням регістру!)          ![img](media/ProficloudV3_Certificate_Store_Create.PNG)        

2) Додайте файл сертифіката `.crt`, який ви отримали на попередньому етапі цих інструкцій
             ![img](media/ProficloudV3_add_certificate.PNG)        

## Device Management Service 

У цій темі ви прочитаєте, як додавати, редагувати або видаляти свої пристрої в Proficloud V3 Device Management Service.

- Кожен пристрій відображає доступні для нього служби на вкладці `Service`.
- Список пристроїв можна шукати або сортувати за бажанням. Наразі доступні параметри сортування  "Name", "Status" та "Device Type".
- Можливість організації та сортування за статусом, назвою, типом пристрою
- Оновлення мікропрограми для пристроїв можна виконувати віддалено. За допомогою налаштувань безпеки помилкові оновлення мікропрограми завжди можна скинути. 
- Користувач може зберігати власні записи журналу в журналі пристрою. Вони ідентифікуються додатковим типом журналу.
- Журнал пристрою автоматично відображає записи журналу пристрою.
- Користувач може додати статичнe інформацію про пристрій. Це включає теги, описи та розташування пристрою.
- Статична інформація, така як UUID, серійний номер, тип пристрою або версія апаратного забезпечення, автоматично відображається на пристрої
- Пристрої можна легко додавати з позначеним UUID
- Світлофор справності для всіх підключених пристроїв (Все ОК = білий, Попередження = жовтий, Критична помилка = червоний), точні значення можна знайти в документації до пристроїв
- Стан працездатності доданих пристроїв можна переглянути онлайн

### Додавання пристроїв до служби керування пристроями Proficloud V3

1) Увійдіть у свій обліковий запис користувача на [www.proficloud.io](https://proficloud.io)

2) Натисніть `Device Management Service` на панелі ліворуч, щоб відкрити сторінку `Device Overview`.

3) Натисніть `ADD DEVICE` на сторінці `Device Overview` 

​          ![img](media/ProficloudV3_1.png)

З’явиться діалогове вікно `New Device`.

![img](media/ProficloudV3_2.png)

4) Введіть **UUID** вашого пристрою PLCnext (надрукований на його корпусі) і **name**, щоб ідентифікувати цей запис в `Device Overview`

5) За бажанням введіть **comment**, **address**, де розташований пристрій, і корисний **tag** для розрізнення великої кількості пристроїв, підключених до одного облікового запису

6) Завершіть, натиснувши кнопку `ADD DEVICE TO PROFICLOUD`

7) Пристрій з'являється в Device Overview
             ![img](media/ProficloudV3_14.png)

8) Якщо ваш пристрій під’єднано до Інтернету, через кілька секунд повідомлення про статус має стати `Online`. Тепер цей пристрій готовий до використання з Proficloud V3.

9) Повторіть процедуру для інших пристроїв.

Підказка. Зі збільшенням списку пристроїв ви можете змінити порядок пристроїв у меню STATUS:

![img](media/ProficloudV3_19.png)

### Редагування або видалення пристроїв з Proficloud V3

Щоб відредагувати або видалити інформацію про пристрій, створену під час процесу реєстрації, натисніть значок із трьома крапками праворуч на картці пристрою та виберіть відповідний пункт меню:

![img](media/ProficloudV3_5.JPG)

 

Діалогове вікно `Edit Device` має приблизно ту саму форму, що й діалогове вікно `New Device`, тому ви можете додати необов’язкову інформацію пізніше:

![img](media/ProficloudV3_6.JPG)

Діалогове вікно `Delete Device` містить підказки щодо того, що станеться, якщо видалити пристрій. Уважно прочитавши, натисніть кнопку підтвердження або скасування:

![img](media/ProficloudV3_7.JPG)

### Додавання віртуальних пристроїв через Node-RED 

[Ресурс](https://proficloud.io/courses/get-to-know-node-red-and-proficloud-io/lessons/installation-of-proficlouddevice-node/) 

Для використання сервісів Proficloud в NodeRED можна встановити бібліотеку **node-red-contrib-proficloud**. Після встановлення ви знайдете ProficloudDevice-Node у категорії Phoenix Contact. Перед підключенням Node до Proficloud.io вам потрібно додати віртуальний UUID до свого облікового запису Proficloud.io.

Щоб отримати UUID для стороннього пристрою, достатньо перейти до Device Management Service та натиснути `Add device`. Тут ви отримуєте можливість отримати опцію для віртуального UUID/віртуального пристрою. Решта процесу відбувається як зазвичай. Після додавання пристрою ви можете скопіювати UUID і використовувати його в Node-RED

![With the new update, virtual devices can be created on Proficloud.io with a few clicks and used for e.g. Node-RED applications.](media/Add_Virtual_Device_to_proficloud.png)

Тепер введіть UUID у конфігурацію ProficloudDevice-Node і активуйте AutoConnect. Після розгортання потоку вузол повинен підключитися до Proficloud. Перше підключення може зайняти деякий час через обмін клієнтськими сертифікатами.

Опис роботи з вузлом в Node-RED наведений в [довіднику Node-RED](https://pupenasan.github.io/NodeREDGuidUKR/phoenixcontact/)

## Використання сервісів керування пристроями 

У цій темі ви дізнаєтеся, яку інформацію можна знайти для своїх пристроїв у Proficloud V3, як інтерпретувати стан працездатності та журнали та як виконати дистанційне оновлення мікропрограми через Proficloud V3.

### Огляд пристроїв

В `Device Overview` кожен пристрій відображається як картка з його даними поруч із картою, на якій показано його геолокацію (якщо введено). Колір картки та піктограми карти відображає стан справності пристрою. Натисніть на картку, щоб розгорнути вкладки служби для цього пристрою.

![img](media/ProficloudV3_3.png)

### Health (працездатність)

![img](media/ProficloudV3_4.png)

Вкладка Health надає приблизну інформацію про стан пристрою залежно від світлодіодів на його корпусі. Наприклад, для PLCnext Control типові світлодіоди використовуються для відображення 3-крокового кольорового коду, який відображається на картці пристрою: 

- Якщо картка <span style="background-color:green; color:white"> зелена</span>  тоді світлодіоди пристрою повідомляють про наступне:  
  - `SF` - не світиться *ТА*
  - `FAIL` - не світиться *ТА*
  - `D` - зелена  *ТА*
  - `E` - не світиться  
- Якщо картка <span style="background-color:yellow; color:black"> жовта</span> тоді світлодіоди пристрою повідомляють про наступне:     
  - `BF-C` - світиться *АБО* 
  - `BF-D` - світиться   *АБО* 
  - `D` - жовта *АБО* 
  - `E` - жовта
- Якщо картка <span style="background-color:red; color:black">червона</span>  тоді світлодіоди пристрою повідомляють про наступне:     
  - `SF` - світиться  *АБО*
  - `FAIL` - світиться *АБО* 
  - `D` - червона  *АБО*
  - `E` - черовна

Статус пристрою  `Device Status` показує, який із станів викликає код кольору. Крім того, на цій вкладці за замовчуванням відображається сповіщення про наявність нового оновлення мікропрограми, тому ви не пропустите його .

### Інформація

На вкладці `Information` ви знайдете ключову інформацію для кожного пристрою. Він містить інформацію, яку ви ввели в процесі реєстрації, а також деякі дані, надані самим пристроєм:

- Коментар
- Місцезнаходження
- Серійний номер
- Тип пристрою
- UUID
- Апаратна версія

![img](media/ProficloudV3_8.JPG)

### Service

На вкладці `Service` у майбутньому будуть перераховані додаткові служби для керування пристроями.

### Logs (журнал)

![img](media/ProficloudV3_9.JPG)

На вкладці `Logs` відображається реєстраційна інформація пристрою, яка надсилається з пристрою до хмари. Ці записи відфільтровуються з файлу `Output.log` на пристрої PLCnext.

### Firmware Update

![img](media/ProficloudV3_10.JPG)

На вкладці `Firmware Update` повністю виконується процес оновлення. PLCnext Control виконає оновлення мікропрограми лише тоді, коли ПЛК перебуває в стані `STOP`. Якщо оновлення потрібно виконати в стані `RUN`, це потрібно ввімкнути у файлі налаштувань, який знаходиться в цьому каталозі на пристрої:

```
  /opt/plcnext/projects/Default/Services/ProfiCloudV3/ProfiCloudV3.config.20.6    
```

Щоб підготувати пристрій до оновлення мікропрограми зі стану `RUN`, увійдіть у пристрій за допомогою WinSCP або подібного програмного забезпечення, перейдіть до файлу `.config ` і змініть параметр `force` у тегу `<FirmwareUpdate>` на ` true`:

```xml
<FirmwareUpdate enabled="true" 
        force="true"        
        artifactServer=""/>     
```

Процес оновлення можна почати, натиснувши кнопку `UPDATE FIRMWARE`. У діалоговому вікні вибору мікропрограми виберіть версію, яку потрібно інсталювати, і натисніть кнопку `UPDATE FIRMWARE NOW` :

![img](media/ProficloudV3_11.JPG)

Дотримуйтеся процесу оновлення, який відображається в повідомленнях про статус:

![img](media/ProficloudV3_12.JPG)

Це оновлення виконано успішно, із зазначенням кожного кроку процесу:

![img](media/ProficloudV3_13.JPG)

## Time-series data (TSD) connector

- Переконайтеся, що підключення Proficloud V3 увімкнено на вашому пристрої PLCnext
         (Примітка: попередні облікові записи Proficloud**.net** тут не працюють!)
- Переконайтеся, що ваш пристрій PLCnext зареєстровано через Device Management Services
- Встановлений PLCnext Engineer і налаштуваний проект

### Підготовка свого проекту на контролері 

Зробіть такі налаштування в PLCnext Engineer, щоб підготувати проект:

- Оголосити змінні, які будуть використовуватися в службі TSD, як OUT Port. Phoenix Contact рекомендує надсилати до Proficloud максимум 50 змінних на один контролер PLCnext. У версії мікропрограми 2021.6 максимум збільшено до 300 змінних.
- Також активуйте прапорець Proficloud.

![img](media/Security-shield.svg)Примітка щодо безпеки: Зверніть увагу, що передані значення змінних можуть переглядати будь-які користувачі облікового запису Proficloud вашої організації. У Proficloud наразі неможливо призначити різні права користувачам.

![Declare variables for TSD service in PLCnext Engineer](media/Bild4.png)

Підтримувані типи даних:

| PLCnext Engineer | Simulink | C++     |
| ---------------- | -------- | ------- |
| BOOL             | Boolean  | boolean |
| BYTE             | uint8    | uint8   |
| DINT             | int32    | int32   |
| DWORD            | uint32   | uint32  |
| INT              | int16    | int16   |
| LINT             |          | int64   |
| LREAL            | double   | double  |
| LWORD            |          | uint64  |
| REAL             | single   | float   |
| SINT             | int8     | int8    |
| UDINT            | uint32   | uint32  |
| UINT             | uint16   | uint16  |
| ULINT            |          | uint64  |
| USINT            | uint8    | uint8   |
| WORD             | uint16   | uint16  |

### Показати значення на інформаційній панелі

- Щойно пристрій зареєстровано, доступ до служби TSD можна отримати в Proficloud V3:

![Time Series Data service](media/Bild6.png)

- Спочатку виберіть UUID пристрою, який надаватиме дані:

![UUID](media/Image_07.png)

Після вибору UUID усі змінні, оголошені для служби TSD у PLCnext Engineer, автоматично відображаються на одному графіку:



![Graph showing the selected variables](media/Image_07_full.png)

### Проміжне зберігання даних

Тимчасово можна зберігати до 1000 елементів даних. Елемент даних (data element) — це значення змінної, яке було записане в певний час. Контролер PLCnext записує дані з інтервалом 1000 мс і надсилає їх на Proficloud кожні 1000 мс, якщо з’єднання встановлено. Дані можна буферизувати, доки не буде досягнуто 1000 елементів. Наприклад, якщо позначено 10 змінних, можна буферизувати 100 с. У разі переповнення пам'яті найстаріші дані будуть видалені.

Якщо з’єднання з Інтернетом переривається, значення тимчасово зберігаються в контролері та надсилаються в Proficloud, як тільки з’єднання буде відновлено. Примітка. Дані, що зберігаються в буфері, втрачаються, коли виконується перезавантаження живлення контролера.

### Створення нової інформаційної панелі

Щоб створити нову інформаційну панель, потрібно перейти до своєї організації.



![Switch to organization](media/Bild8.png)   

Рис. Переключення організації

Деталі https://proficloud.io/faqs/time-series-data/

### Налаштування тривог

Ви також можете встановити тривоги для кожної панелі у вашій організації. Щойно правило виконується (перевищення/заниження значення), визначеним одержувачам надсилається повідомлення.

Деталі https://proficloud.io/faqs/time-series-data/